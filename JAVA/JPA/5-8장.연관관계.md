# 연관관계?
ORM에서 가장 어려운 부분이 객체 연관관계와 테이블 연관관계를 매핑하는 일.

> 목표 - 객체의 참조와 테이블의 외래 키를 매핑하는 것. 

매핑을 이해하기 위한 Keyword

* 방향
    - 단방향 : 객체
    - 양방향 : 테이블 
* 다중성
    - 다대일
    - 일대다
    - 일대일
    - 다대다
* 연관관계의 주인
    - 객체를 양방향 연관관계 설정 시, 연관관계의 주인 정해야한다.
    
# 단방향 연관관계
다대일(N:1)의 단방향 관계
* 회원과 팀
* 회원은 하나의 팀에만 속할 수 있다.
* 회원과 팀은 다대일
 
> 객체 연관관계

- 회원은 팀을 알 수 있지만, 팀은 회원을 알 수 없다.

> 테이블 연관관계

- 회원 테이블은 TEAM_ID로 팀 테이블과 연관 관계

> 둘의 차이

- 객체는 참조(주소)로 연관관계를 맺는다.
- 테이블은 외래 키로 연관관계를 맺는다.

## 저장

````java
public void testSave(){
    //팀1 저장
    Team team1 = new Team("team1","팀1");
    em.persist(team1);
    
    //회원1 저장
    Member member1 = new Member("member1", "회원1");
    member1.setTeam(team1);
    em.persist(member1);
    
    //회원2 저장
    Member member2 = new Member("member2", "회원2");
    member2.setTeam(team1);
    em.persist(member2);
}
````
이렇게 할 경우, 아래와 같은 쿼리가 입력된다.
````
INSERT INTO TEAM (TEAM_ID, NAME) VALUES ('team1','팀1')
INSERT INTO MEMBER (MEMBER_ID, NAME, TEAM_ID) VALUES ('member1','회원1','team1')
INSERT INTO MEMBER (MEMBER_ID, NAME, TEAM_ID) VALUES ('member2','회원2','team1')
````
외래 키 값으로 참조한 팀의 식별자 값인 team1이 입력된 것을 알 수 있다.

## 조회
### 객체 그래프 탐색

객체를 통해 연관된 엔티티를 조회하는 것을 객체 그래프 탐색이라 한다.

````java
Member member = em.find(Member.class, "member1");
Team team = member.getTeam(); //객체 그래프 탐색
````
### 객체지향 쿼리 사용
````java
private static void queryLogicJoin(EntityManager em){
    String jpql = "select m from Member m join m.team t where t.name=:teamName";
    List<Member> resultList = em.createQuery(jpql, Member.class).setParameter("teamName","팀1")
                                .getResultList();

}
````

## 수정
````java
private static void updateRelation(EntityManager em) {
    Team team2 = new Team("team2","팀2");
    em.persist(team2);

    Member member = em.find(Member.class, "member1");
    member.setTeam(team2);
}
````

# 양방향 연관관계

## 매핑
* 1:N이었던 회원 엔티티와 팀 엔티티
* 팀 엔티티에 OneToMany를 추가

## 연관관계의 주인
테이블에 외래 키가 있는 곳

### 무엇인가?
1. 객체에는 단방향 두개가 양방향처럼 보이는 것
2. 엔티티를 양방향 연관관계로 설정하면 객체 참조는 둘인데 외래 키는 하나
3. 둘 사이에 차이 발생
4. 연관관계 중 하나 정해서 테이블의 외래키 관리해야한다.

### 역할
연관관계의 주인만이 데이터베이스 연관관계와 매핑되고, 외래 키를 관리할 수 있다.
주인 아닌 쪽은 읽기만 가능.

## 어떻게 작성해야할까
````java
public void test() {
    //팀1 저장
    Team team1 = new Team("team1", "팀1");
    em.persist(team1);

    Member member1 = new Member("member1", "회원1");
    
    //양방향 연관관계 설정 (양방향 두개 해줘야 안정적 but 번거롭다)
    member1.setTeam(team1);             //연관관계 설정 member1 -> team1
    team1.getMembers().add(member1);    //연관관계 설정 team1 -> member1 
    em.persist(member1);
}
````

## 번거로우니 리팩토링을 해보자
setTeam() 메소드를 수정하여 번거로움을 없앨 수 있다.
이때, 팀과 회원 연관관계에서 **삭제되지 않은 관계**가 있을 수 있으니 버그 주의!
````java
public class Member {
    private Team team;

    public void setTeam(Team team){
        //기존 팀 관계를 제거
        if (this.team != null) {
            this.team.getMembers().remove(this);
        }
        this.team = team;
        team.getMembers().add(this);
    }

}
````

## 정리
* 양방향을 위해 로직을 잘 관리해야 한다(양방향 지정 및 기존 팀 관계 제거 관련)
* 단방향을 양방향으로 만드려면, 반대방향으로 객체 그래프 탐색 기능 추가
* 연관관계의 주인은 외래 키가 있는 곳
* 주인의 반대편은 mappedBy로 주인 지정 필요

